/*!
 * VERSION: 0.3.0
 * DATE: 2016-8-17
 * GIT: https://github.com/shrekshrek/jstween
 * @author: Shrek.wang
 **/

!function(e){if("function"==typeof define&&define.amd)define(["jstween","exports"],function(i,t){window.JTL=e(t,i)});else if("undefined"!=typeof exports){var i=require("jstween");e(exports,i)}else window.JTL=e({},window.JT)}(function(e,i){function t(e,i){for(var t in i)e[t]=i[t]}function n(e){var i=/(^[a-zA-Z]\w*|)(\+=|-=|)(\d*\.\d*|\d*)/,t=i.exec(e);return{label:t[1],ext:t[2],num:parseFloat(t[3])}}function s(){o=!0;var e=h.length;if(0===e)return void(o=!1);var t=i.now(),n=t-l;l=t;for(var a=e-1;a>=0;a--)h[a]._update(n);r(s)}function a(){this.initialize.apply(this,arguments)}var r=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},h=[],o=!1,l=0;return t(a.prototype,{initialize:function(){this.labels=[],this.labelTime=0,this.anchors=[],this.anchorId=0,this.tweens=[],this.isPlaying=!1,this.curTime=0},_update:function(e){this.isPlaying&&(this.curTime+=e,this._checkHandler())},_addSelf:function(){h.push(this),o||(l=i.now(),s())},_removeSelf:function(){var e=h.indexOf(this);-1!==e&&h.splice(e,1)},_checkHandler:function(){var e=this.anchors.length;if(this.anchorId>=e)return this._removeSelf(),void(this.isPlaying=!1);var i=this.anchors[this.anchorId];this.curTime>=1e3*i.time&&(this.anchorId==e-1?(this._removeSelf(),this.isPlaying=!1,i.handler.apply()):(i.handler.apply(),this.anchorId++,this._checkHandler()))},_parseTweenTime:function(e,i,t){var n=Math.max(e,0),s=Math.max(i.delay||0,0),a=Math.max(0,Math.floor(i.repeat||0)),r=Math.max(i.repeatDelay||0,0),h=s+n+(r+n)*a,o=this._parsePosition(t);return this.labelTime=Math.max(this.labelTime,o+h),o},_parsePosition:function(e){if(void 0==e)return this.labelTime;var i=n(e),t=0;switch(i.label?t=this.getLabelTime(i.label):i.ext?t=this.labelTime:i.num&&(t=i.num),i.ext){case"+=":t+=i.num;break;case"-=":t-=i.num}return t},_addAnchor:function(e,i){var t=this.anchors.length;if(0==t)return void this.anchors.push({time:i,handler:e});if(t>0)for(var n=t-1;n>=0;n--){var s=this.anchors[n];if(i>=s.time)return void this.anchors.splice(n+1,0,{time:i,handler:e})}},_addTween:function(e){if(void 0!=e.length)for(var i in e)this.tweens.push(e[i]);else this.tweens.push(e)},_removeTween:function(e){var i=this.tweens.indexOf(e);-1!==i&&this.tweens.splice(i,1)},fromTo:function(e,t,n,s,a){var r=this,h=s.onEnd;s.onEnd=function(e){r._removeTween(this),h&&h.apply(this,e)};var o=function(){var a=i.fromTo(e,t,n,s);r._addTween(a)},l=this._parseTweenTime(t,s,a);return this._addAnchor(o,l),this},from:function(e,t,n,s){var a=this,r=n.onEnd;n.onEnd=function(e){a._removeTween(this),r&&r.apply(this,e)};var h=function(){var s=i.from(e,t,n);a._addTween(s)},o=this._parseTweenTime(t,n,s);return this._addAnchor(h,o),this},to:function(e,t,n,s){var a=this,r=n.onEnd;n.onEnd=function(e){a._removeTween(this),r&&r.apply(this,e)};var h=function(){var s=i.to(e,t,n);a._addTween(s)},o=this._parseTweenTime(t,n,s);return this._addAnchor(h,o),this},kill:function(e,t){var n=function(){i.kill(e,!0)},s=this._parseTweenTime(0,{},t);return this._addAnchor(n,s),this},add:function(e,i){var t=this._parsePosition(i);switch(typeof e){case"function":this._addAnchor(e,t);break;case"string":this.addLabel(e,t);break;default:throw"add action is wrong!!!"}return this},addLabel:function(e,i){this.removeLabel(e);var t=this._parsePosition(i);return this.labels.push({name:e,time:t}),this},removeLabel:function(e){for(var i=this.labels.length,t=i-1;t>=0;t--){var n=this.labels[t];if(e==n.name)return this.labels.splice(t,1),this}return this},getLabelTime:function(e){for(var i=this.labels.length,t=i-1;t>=0;t--){var n=this.labels[t];if(e==n.name)return n.time}return this.labelTime},totalTime:function(){return this.labelTime},play:function(e){this.isPlaying&&this.pause();for(var i=this.tweens.length,t=i-1;t>=0;t--)this.tweens[t].play();this._addSelf(),this.isPlaying=!0,void 0!==e&&this.seek(e)},pause:function(){if(this.isPlaying){for(var e=this.tweens.length,i=e-1;i>=0;i--)this.tweens[i].pause();this._removeSelf(),this.isPlaying=!1}},seek:function(e){var i=this._parsePosition(e);this.curTime=1e3*i;for(var t=this.anchors.length,n=0;t>n;n++){var s=this.anchors[n];if(1e3*s.time>=this.curTime)return void(this.anchorId=n)}},clear:function(){for(var e=this.tweens.length,i=e-1;i>=0;i--)this.tweens[i].kill();this.tweens=[],this.curTime=0,this.labels=[],this.labelTime=0,this.anchors=[],this.anchorId=0}}),t(e,{create:function(){return new a},kill:function(e){e.clear()}}),e});
